name: Build and Release

on:
  push:
    branches:
      - live
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release'
        required: true
        default: 'true'
        type: boolean
      bridge_release:
        description: 'Bridge release (ONE-TIME: publishes to GitHub as latest for migration)'
        required: true
        default: 'false'
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  RUST_VERSION: 'stable'
  PYTHON_VERSION: '3.11'
  UPDATE_SERVER_URL: 'https://updates.c4tx.top/companella'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: live
          fetch-depth: 0
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            msd-calculator/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('msd-calculator/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore .NET dependencies
        run: dotnet restore OsuMappingHelper/OsuMappingHelper.csproj

      - name: Download previous release for delta generation
        id: prev_release
        shell: pwsh
        continue-on-error: true
        run: |
          # Create Releases directory
          New-Item -ItemType Directory -Path "Releases" -Force | Out-Null
          
          # Download from update server for delta generation
          $baseUrl = "${{ env.UPDATE_SERVER_URL }}"
          
          try {
            # Download RELEASES file
            echo "Downloading RELEASES from update server..."
            $releasesUrl = "$baseUrl/RELEASES"
            Invoke-WebRequest -Uri $releasesUrl -OutFile "Releases/RELEASES" -UseBasicParsing -ErrorAction Stop
            echo "RELEASES file downloaded"
            
            # Parse RELEASES to find the latest full nupkg
            $releasesContent = Get-Content "Releases/RELEASES" -Raw
            # Force array even with single result (PowerShell gotcha)
            $lines = @($releasesContent -split "`n" | Where-Object { $_ -match "-full\.nupkg" })
            
            if ($lines.Count -gt 0) {
              # Get the last (latest) full nupkg entry
              $lastLine = $lines[-1].Trim()
              if ($lastLine -match '(\S+\.nupkg)') {
                $nupkgName = $matches[1]
                echo "Downloading $nupkgName for delta generation..."
                $nupkgUrl = "$baseUrl/$nupkgName"
                Invoke-WebRequest -Uri $nupkgUrl -OutFile "Releases/$nupkgName" -UseBasicParsing -ErrorAction Stop
                echo "Downloaded: $nupkgName"
                echo "PREV_RELEASE_FOUND=true" >> $env:GITHUB_OUTPUT
              }
            } else {
              echo "No full nupkg entries found in RELEASES"
              echo "PREV_RELEASE_FOUND=false" >> $env:GITHUB_OUTPUT
            }
            
            # List downloaded files
            echo "=== Downloaded files for delta generation ==="
            Get-ChildItem "Releases" -ErrorAction SilentlyContinue | ForEach-Object {
              echo "  $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
            }
          } catch {
            echo "Could not download from update server (may be first release): $_"
            # Fallback: try GitHub for bridge release scenario
            if ("${{ github.event.inputs.bridge_release }}" -eq "true") {
              echo "Bridge release: trying GitHub as fallback..."
              try {
                $releases = gh release list --limit 1 --json tagName | ConvertFrom-Json
                if ($releases -and $releases.Count -gt 0) {
                  $latestTag = $releases[0].tagName
                  echo "Found previous GitHub release: $latestTag"
                  gh release download $latestTag --pattern "RELEASES" --dir "Releases" --clobber 2>&1
                  gh release download $latestTag --pattern "*-full.nupkg" --dir "Releases" --clobber 2>&1
                  echo "PREV_RELEASE_FOUND=true" >> $env:GITHUB_OUTPUT
                }
              } catch {
                echo "GitHub fallback also failed: $_"
                echo "PREV_RELEASE_FOUND=false" >> $env:GITHUB_OUTPUT
              }
            } else {
              echo "PREV_RELEASE_FOUND=false" >> $env:GITHUB_OUTPUT
            }
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run build script
        shell: pwsh
        run: |
          ./build.ps1 -Configuration Release

      - name: Read version (after build increment)
        id: version
        shell: pwsh
        run: |
          $version = Get-Content "OsuMappingHelper/version.txt" -Raw
          $version = $version.Trim()
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          # Convert to semver for Squirrel (v5.60 -> 5.60.0)
          $semver = $version -replace '^v', ''
          if ($semver -notmatch '^\d+\.\d+\.\d+') {
            if ($semver -match '^\d+\.\d+$') {
              $semver = "$semver.0"
            }
          }
          echo "SEMVER=$semver" >> $env:GITHUB_OUTPUT
          echo "Version: $version (semver: $semver)"

      - name: Clean RELEASES file (bridge release only)
        if: github.event.inputs.bridge_release == 'true'
        shell: pwsh
        run: |
          # For bridge release: clean RELEASES to only contain current version
          # This ensures old clients do a full update to the bridge
          $semver = "${{ steps.version.outputs.SEMVER }}"
          $releasesFile = "Releases/RELEASES"
          
          if (Test-Path $releasesFile) {
            echo "Cleaning RELEASES file for bridge release..."
            $content = Get-Content $releasesFile | Where-Object { $_ -match "Companella-$semver" }
            $content | Set-Content $releasesFile
            echo "RELEASES now contains only version $semver"
            Get-Content $releasesFile
          }

      - name: List release artifacts
        shell: pwsh
        run: |
          echo "=== Release Artifacts ==="
          Get-ChildItem -Path "Releases" -Recurse | ForEach-Object {
            $size = if ($_.PSIsContainer) { "" } else { "($([math]::Round($_.Length / 1MB, 2)) MB)" }
            echo "$($_.FullName) $size"
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ steps.version.outputs.VERSION }}
          path: Releases/
          retention-days: 30

      - name: Upload to update server
        if: (github.ref == 'refs/heads/live' || github.event_name == 'workflow_dispatch') && github.event.inputs.bridge_release != 'true'
        shell: pwsh
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Write SSH key to temp file with proper format
          $keyFile = Join-Path $env:RUNNER_TEMP "deploy_key"
          
          # Use .NET to write the key with Unix line endings (LF only)
          $keyContent = $env:DEPLOY_SSH_KEY -replace "`r`n", "`n" -replace "`r", "`n"
          # Ensure key ends with newline
          if (-not $keyContent.EndsWith("`n")) {
            $keyContent += "`n"
          }
          [System.IO.File]::WriteAllText($keyFile, $keyContent)
          
          echo "SSH key written to: $keyFile"
          echo "Key file size: $((Get-Item $keyFile).Length) bytes"
          
          # Fix Windows file permissions - SSH requires private key to be readable only by owner
          # Remove inheritance and all existing permissions
          icacls $keyFile /inheritance:r
          # Grant only the current user read access
          icacls $keyFile /grant:r "$($env:USERNAME):(R)"
          # Remove BUILTIN\Users if present
          icacls $keyFile /remove "BUILTIN\Users" 2>$null
          icacls $keyFile /remove "Users" 2>$null
          
          echo "Key file permissions set"
          
          # Upload files via SCP with verbose output
          $destination = "$($env:DEPLOY_USER)@$($env:DEPLOY_HOST):$($env:DEPLOY_PATH)/"
          
          echo "Uploading to $destination..."
          
          # Collect all files to upload
          $filesToUpload = @()
          
          if (Test-Path "Releases/RELEASES") {
            $filesToUpload += "Releases/RELEASES"
          }
          
          Get-ChildItem "Releases" -Filter "*.nupkg" | ForEach-Object {
            $filesToUpload += $_.FullName
          }
          
          Get-ChildItem "Releases" -Filter "*Setup.exe" | ForEach-Object {
            $filesToUpload += $_.FullName
          }
          
          echo "Files to upload: $($filesToUpload.Count)"
          $filesToUpload | ForEach-Object { echo "  - $_" }
          
          # Upload each file
          foreach ($file in $filesToUpload) {
            $fileName = Split-Path $file -Leaf
            echo "Uploading $fileName..."
            
            # Use Start-Process to avoid hanging
            $scpArgs = @(
              "-v",
              "-o", "StrictHostKeyChecking=no",
              "-o", "UserKnownHostsFile=NUL",
              "-o", "BatchMode=yes",
              "-i", $keyFile,
              $file,
              $destination
            )
            
            $process = Start-Process -FilePath "scp" -ArgumentList $scpArgs -NoNewWindow -Wait -PassThru
            
            if ($process.ExitCode -ne 0) {
              throw "Failed to upload $fileName (exit code: $($process.ExitCode))"
            }
            
            echo "Uploaded $fileName successfully"
          }
          
          echo "Upload complete!"
          
          # Clean up key file
          Remove-Item $keyFile -Force -ErrorAction SilentlyContinue

      - name: Create version tag
        if: github.ref == 'refs/heads/live' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          echo "Creating tag: $version"
          
          # Check if tag already exists
          $existingTag = git tag -l $version
          if ($existingTag) {
            echo "Tag $version already exists, skipping creation"
          } else {
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a $version -m "Release $version"
            git push origin $version
            echo "Tag $version created and pushed"
          }

      # Bridge release: Full GitHub release with Squirrel files (ONE-TIME for migration)
      - name: Create GitHub Release (Bridge)
        if: github.event.inputs.bridge_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Companella! ${{ steps.version.outputs.VERSION }}
          body: |
            ## Companella! ${{ steps.version.outputs.VERSION }}
            
            ### Installation
            
            **New Users:** Download and run `CompanellaSetup.exe`
            
            **Existing Users:** The app will auto-update, or download the latest `CompanellaSetup.exe`
            
            ### Files
            - `CompanellaSetup.exe` - Installer (run this to install or update)
            - `Companella-${{ steps.version.outputs.SEMVER }}-full.nupkg` - Full update package
            - `RELEASES` - Release manifest for auto-updater
          files: |
            Releases/*Setup.exe
            Releases/RELEASES
            Releases/Companella-${{ steps.version.outputs.SEMVER }}-full.nupkg
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Normal release: GitHub release for changelog only (no Squirrel files, not marked as latest)
      - name: Create GitHub Release (Normal)
        if: (github.ref == 'refs/heads/live' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')) && github.event.inputs.bridge_release != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Companella! ${{ steps.version.outputs.VERSION }}
          body: |
            ## Companella! ${{ steps.version.outputs.VERSION }}
            
            ### Installation
            
            **New Users:** Download `CompanellaSetup.exe` and run it.
            
            **Existing Users:** The app will auto-update automatically.
            
            ### Manual Download
            - `CompanellaSetup.exe` - Installer (run this to install or update)
          files: |
            Releases/*Setup.exe
          draft: false
          prerelease: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
